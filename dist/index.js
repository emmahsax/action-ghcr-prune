(()=>{var __webpack_modules__={799:(e,t,n)=>{const a=n(486);const{Buffer:r}=n(300);const createDockerAPIClient=()=>{const e=new a.HttpClient("github-action");return e};const dockerAPIGet=(e,t,n,a)=>async s=>{const o=r.from(t).toString("base64");const i={Accept:`application/vnd.oci.image.index.v1+json`,Authorization:`Bearer ${o}`};const c=`https://ghcr.io/v2/${n}/${a}/${s}`;const u=await e.get(c,i);if(u.message.statusCode!=200){throw new Error(`Docker API request at ${c} was not successful. Status code: ${u.message.statusCode}, Status message: ${u.message.statusMessage}`)}return u};const getManifest=e=>async t=>{const n=await e(`manifests/${t}`);const a=await n.readBody();const r=JSON.parse(a);return r};e.exports={getManifest:getManifest,createDockerAPIClient:createDockerAPIClient,dockerAPIGet:dockerAPIGet}},354:e=>{const deleteAuthenticatedUserContainerVersion=e=>t=>n=>e.rest.packages.deletePackageVersionForAuthenticatedUser({package_type:"container",package_name:t,package_version_id:n.id});const deleteOrgContainerVersion=e=>(t,n)=>a=>e.rest.packages.deletePackageVersionForOrg({package_type:"container",org:t,package_name:n,package_version_id:a.id});const deleteUserContainerVersion=e=>(t,n)=>a=>e.rest.packages.deletePackageVersionForUser({package_type:"container",username:t,package_name:n,package_version_id:a.id});const listAuthenticatedUserContainerVersions=e=>t=>(n,a=1)=>e.rest.packages.getAllPackageVersionsForPackageOwnedByAuthenticatedUser({package_type:"container",package_name:t,page:a,per_page:n,state:"active"});const listOrgContainerVersions=e=>(t,n)=>(a,r=1)=>e.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({package_type:"container",org:t,package_name:n,page:r,per_page:a,state:"active"});const listUserContainerVersions=e=>(t,n)=>(a,r=1)=>e.rest.packages.getAllPackageVersionsForPackageOwnedByUser({package_type:"container",username:t,package_name:n,page:r,per_page:a,state:"active"});e.exports={deleteAuthenticatedUserContainerVersion:deleteAuthenticatedUserContainerVersion,deleteOrgContainerVersion:deleteOrgContainerVersion,deleteUserContainerVersion:deleteUserContainerVersion,listAuthenticatedUserContainerVersions:listAuthenticatedUserContainerVersions,listOrgContainerVersions:listOrgContainerVersions,listUserContainerVersions:listUserContainerVersions}},154:(e,t,n)=>{const a=n(942);const{digestFilter:r}=n(426);const s=100;const sortByVersionCreationDesc=(e,t)=>-e.created_at.localeCompare(t.created_at);const getAllMultiPlatList=(e,t)=>async n=>{const r=[];let o=[];let i=0;let c=1;a.info("Crawling through all versions for multi-platform images...");do{const{data:t}=await e(s,c);i=t.length;o=[...o,...t];c++}while(i>=s);for(const e of o){if(e.metadata.container.tags.length==0){continue}const n=await t(e.metadata.container.tags[0]);if(n.mediaType!="application/vnd.oci.image.index.v1+json"){continue}for(const e of n.manifests){a.info(`Found subimage: ${e.digest}`);r.push(e.digest)}}return r};const getMultiPlatPruningList=(e,t)=>async n=>{a.info("Crawling through pruning list for multi-platform images...");const s=[];for(const e of n){const n=await t(e.metadata.container.tags[0]);if(n.mediaType!="application/vnd.oci.image.index.v1+json"){continue}for(const e of n.manifests){a.info(`Found subimage: ${e.digest}`);s.push(e.digest)}}if(s.length){const t=r(s);const n=getPruningList(e,t)(0);return n}else{return undefined}};const getPruningList=(e,t)=>async(n=0)=>{let r=[];let o=1;let i=0;a.info("Crawling through all versions to build pruning list...");do{const{data:n}=await e(s,o);i=n.length;const c=n.filter(t);r=[...r,...c];a.info(`Found ${c.length} versions to prune out of ${i} on page ${o}`);o++}while(i>=s);if(n>0){a.info(`Keeping the last ${n} versions, sorted by creation date`);return r.sort(sortByVersionCreationDesc).slice(n)}return r};const prune=e=>async t=>{const n=[];try{a.startGroup(`Pruning ${t.length} versions...`);for(const r of t){a.info(`Pruning version #${r.id} named '${r.name}'...`);await e(r);n.push(r)}a.endGroup()}catch(e){a.endGroup();a.error(`Failed to prune because of: ${e}`)}a.notice(`Pruned ${n.length} versions`);return n};e.exports={getAllMultiPlatList:getAllMultiPlatList,getMultiPlatPruningList:getMultiPlatPruningList,getPruningList:getPruningList,prune:prune}},426:e=>{const t=1e3*60*60*24;const daysBetween=(e,n=new Date)=>Math.floor((n.getTime()-e.getTime())/t);const anyRegexMatch=e=>t=>e.some((e=>t.some((t=>t.match(e)))));const versionFilter=e=>t=>{const{keepTags:n,keepTagsRegexes:a,keepYoungerThan:r,pruneTagsRegexes:s,pruneUntagged:o}=e;const i=new Date(t.created_at);const c=daysBetween(i);if(r>c){return false}const u=t.metadata.container.tags;if(o&&(!u||!u.length)){return true}if(n&&u&&n.some((e=>u.includes(e)))){return false}if(a&&u&&anyRegexMatch(a)(u)){return false}if(s&&u&&anyRegexMatch(s)(u)){return true}return false};const digestFilter=e=>t=>{const n=e.find((e=>t.name==e));if(n){return true}else{return false}};e.exports={versionFilter:versionFilter,digestFilter:digestFilter}},942:module=>{module.exports=eval("require")("@actions/core")},234:module=>{module.exports=eval("require")("@actions/github")},486:module=>{module.exports=eval("require")("@actions/http-client")},300:e=>{"use strict";e.exports=require("buffer")}};var __webpack_module_cache__={};function __nccwpck_require__(e){var t=__webpack_module_cache__[e];if(t!==undefined){return t.exports}var n=__webpack_module_cache__[e]={exports:{}};var a=true;try{__webpack_modules__[e](n,n.exports,__nccwpck_require__);a=false}finally{if(a)delete __webpack_module_cache__[e]}return n.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var __webpack_exports__={};(()=>{const e=__nccwpck_require__(942);const t=__nccwpck_require__(234);const{deleteAuthenticatedUserContainerVersion:n,deleteOrgContainerVersion:a,deleteUserContainerVersion:r,listAuthenticatedUserContainerVersions:s,listOrgContainerVersions:o,listUserContainerVersions:i}=__nccwpck_require__(354);const{getAllMultiPlatList:c,getMultiPlatPruningList:u,getPruningList:g,prune:l}=__nccwpck_require__(154);const{versionFilter:d}=__nccwpck_require__(426);const{getManifest:p,createDockerAPIClient:_,dockerAPIGet:f}=__nccwpck_require__(799);const asBoolean=e=>"true"==String(e);const versionSummary=e=>JSON.stringify({id:e.id,name:e.name,created_at:e.created_at,tags:e.metadata.container.tags});const dryRunDelete=t=>new Promise((n=>{e.info(`Dry-run pruning of: ${versionSummary(t)}`);n()}));const writeSummary=async(t,n,a,r)=>{const s=a.length===r.length;let o=e.summary.addHeading(`Pruning versions for container: ${t}`,2);if(n){o=o.addRaw(":warning: This is a dry run, no container versions were actually deleted.")}else{o=o.addRaw(`${s?":white_check_mark:":":x:"} ${r.length} out of ${a.length} identified versions were pruned successfully.`)}await o.addHeading("Pruned versions",3).addRaw(`The following ${r.length} versions were successfully pruned:`).addTable([[{data:"ID",header:true},{data:"Name",header:true},{data:"Created at",header:true},{data:"Tags",header:true}],...r.map((e=>[String(e.id),e.name,e.created_at.replace("T"," "),e.metadata.container.tags.join(", ")]))]).write()};const run=async()=>{try{const m=e.getInput("token");const h=e.getInput("organization");const k=e.getInput("user");if(h&&k){e.setFailed("Inputs `organization` and `user` are mutually exclusive and must not both be provided in the same run.");return}const w=e.getInput("container");const v=asBoolean(e.getInput("remove-multi-platform"));const y=asBoolean(e.getInput("dry-run"));const b=Number(e.getInput("keep-last"));const x=e.getInput("tag-regex")?[e.getInput("tag-regex")]:null;const I=asBoolean(e.getInput("prune-untagged"))||asBoolean(e.getInput("untagged"));if(v&&I){e.setFailed("Inputs `remove-multi-platform` and `prune-untagged` are mutually exclusive and must not both be provided in the same run.");return}if(v&&!(h||k)){e.setFailed("Inputs `remove-multi-platform` requires either `organization` or `user` to defined");return}const P={keepTags:e.getMultilineInput("keep-tags"),keepTagsRegexes:e.getMultilineInput("keep-tags-regexes"),keepYoungerThan:Number(e.getInput("keep-younger-than"))||Number(e.getInput("older-than")),pruneTagsRegexes:e.getInput("prune-tags-regexes")?e.getMultilineInput("prune-tags-regexes"):x,pruneUntagged:I};const $=t.getOctokit(m);let C;let F;let V;if(k){C=i($)(k,w);F=y?dryRunDelete:r($)(k,w);V=k}else if(h){C=o($)(h,w);F=y?dryRunDelete:a($)(h,w);V=h}else{C=s($)(w);F=y?dryRunDelete:n($)(w)}const A=d(P);const T=await g(C,A)(b);if(v){const e=_();const t=f(e,m,V,w);const n=p(t);const a=await u(C,n)(T);if(a){T.push(...a)}}else if(I){const e=_();const t=f(e,m,V,w);const n=p(t);const a=await c(C,n)(T);console.log("Identified "+a.length+" untagged images that are a part of a multi-arch image");for(let e=T.length-1;e>=0;e--){const t=T[e];if(a.includes(t.name)){T.splice(e,1)}}}e.info(`Found a total of ${T.length} versions to prune`);const q=await l(F)(T);await writeSummary(w,y,T,q);if(q.length!==T.length){e.setFailed(`Failed to prune some versions: ${q.length} out of ${T.length} versions were pruned`)}e.setOutput("count",q.length);e.setOutput("prunedVersionIds",q.map((e=>e.id)));e.setOutput("dryRun",y)}catch(t){e.setFailed(t.message)}};run()})();module.exports=__webpack_exports__})();